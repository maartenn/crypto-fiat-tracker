<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calculate profit on your wallet</title></head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<link href="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-1.13.8/b-2.4.2/b-html5-2.4.2/sc-2.3.0/datatables.min.css" rel="stylesheet">

<body class="bg-body-tertiary">
<div class="container">
    <h1>Enter Address to calculate your DCA profit</h1>
    <form id="addressForm">
        <div class="input-group mb-3">
            <input id="addressInput" type="text" class="form-control" placeholder="Bitcoin Address" aria-label="Bitcoin Address" aria-describedby="basic-addon2" th:value="${address}" required pattern=".*\S+.*" title="This field is required">
            <div class="input-group-append">
                <button id="addressBtn" class="btn btn-outline-secondary" type="submit">Show graph</button>
            </div>
        </div>
    </form>
    <div class="alert alert-danger alert-dismissible d-none">
        Something went wrong retrieving the data, please try again.
        <button type="button" class="btn-close" data-dismiss="alert" aria-hidden="true"></button>
    </div>
    <div class="spinner-border d-none" role="status">
        <span class="sr-only"></span>
    </div>
    <div id="data">
        <div class="container text-center">
            <div class="row">
                <div class="col">
                    Total Sats
                    <h1 id="totalSats"></h1>
                </div>
                <div class="col">
                    Total Eur Value Deposited
                    <h1 id="totalEurValueDeposited"></h1>
                </div>
                <div class="col">
                    Total Eur Value Now
                    <h1 id="totalEurValueNow"></h1>
                </div>
                <div class="col">
                    Profit
                    <h1 id="profit"></h1>
                </div>
            </div>
        </div>


        <canvas id="myChart"></canvas>
        <table id="example" class="display table table-striped" style="width:100%">
            <thead>
            <tr>
                <th>Transaction Id</th>
                <th>Timestamp</th>
                <th>Amount in sats</th>
                <th>Value in eur at time</th>
                <th>Value eur now</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-1.13.8/b-2.4.2/b-html5-2.4.2/sc-2.3.0/datatables.min.js"></script>

<script>
    $(document).ready(function () {
        $.ajaxSetup({timeout:15000});
        $('#data').hide();
        $('#example').DataTable();
        // setup
        const myChart = new Chart(document.getElementById('myChart'), {
            type: 'line',
            data: {
                labels: [], // Lege labels, worden dynamisch gevuld
                datasets: [{
                    label: 'Eur At Moment Of Depositing',
                    data: [], // Lege dataset, wordt dynamisch gevuld
                    borderColor: 'blue',
                    borderWidth: 1,
                    pointRadius: 0,
                }, {
                    label: 'Eur Value Now',
                    data: [], // Lege dataset, wordt dynamisch gevuld
                    borderColor: 'red',
                    borderWidth: 1,
                    pointRadius: 0,
                }]
            },
            // add animation to chart
            'animation': {
                'duration': 2000,
                'easing': 'easeInOutQuart'
            },
            options: {
                transitions: {
                    show: {
                        animations: {

                            y: {
                                from: 0
                            }
                        }
                    },
                    hide: {
                        animations: {
                            x: {
                                to: 0
                            },
                            y: {
                                to: 0
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'month',
                            displayFormats: {
                                month: 'MMM yy'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        beginAtZero: true,
                    }
                }
            }
        });

        // if address is filled then load data
        if ($('#addressInput').val() !== '') {
            let value = $('#addressInput').val();
            getDataForAddress(value);
        }

        function getDataForAddress(value) {

            $("#addressBtn").prop("disabled", true);
            // $("#addressBtn").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            $('.spinner-border').removeClass('d-none');


            $.get("transactions/" + value)
                .always(function (data) {
                    // enable button again
                    $("#addressBtn").prop("disabled", false);
                    $('.spinner-border').addClass('d-none');
                })
                .fail(function (data) {
                    $('.alert').removeClass('d-none');
                })
                .done(function (data) {
                    $('.alert').addClass('d-none');
                    $('#data').show();

                    // alert( "Data Loaded: " + data );
                    let dataTable = $('#example').DataTable();
                    dataTable.clear();
                    // Voeg alle nieuwe rijen in één keer toe
                    dataTable.rows.add(data.mappedTransactions.map(item => [
                        item.txId,
                        item.timestamp,
                        item.txAmountSats,
                        item.txAmountEur,
                        item.txAmountEurNow,
                    ]));
                    dataTable.order([1, 'desc']); // Sorteer op kolom 1 (timestamp) in aflopende volgorde])]

                    // Teken de tabel opnieuw
                    dataTable.draw();

                    const labels = data.dailyData.map(item => new Date(item.day));
                    const dataDepositing = data.dailyData.map(item => item.totalAmountEurAtMomentOfDepositing);
                    const dataValueNow = data.dailyData.map(item => item.totalAmountEurValueNow);

                    // Update de labels en datasets van de grafiek
                    myChart.data.labels = labels;
                    myChart.data.datasets[0].data = dataDepositing; // first dataset
                    myChart.data.datasets[1].data = dataValueNow;   // second dataset

                    // redraw the chart
                    myChart.update();
//animate totalsats to start counting from zero
                    $({Counter: 0}).animate({
                        Counter: data.sats
                    }, {
                        duration: 2000,
                        easing: 'swing',
                        step: function () {
                            $('#totalSats').text(Math.ceil(this.Counter) + " sats");
                        }
                    });
                    //animate totalsats to start counting from zero
                    $({Counter: 0}).animate({
                        Counter: data.netEurDeposited
                    }, {
                        duration: 2000,
                        easing: 'swing',
                        step: function () {
                            $('#totalEurValueDeposited').text('€ ' + Math.ceil(this.Counter));
                        }
                    });
                    //animate totalsats to start counting from zero
                    $({Counter: 0}).animate({
                        Counter: data.totalEurValueNow
                    }, {
                        duration: 2000,
                        easing: 'swing',
                        step: function () {
                            $('#totalEurValueNow').text('€ ' + Math.ceil(this.Counter));
                        }
                    });
                    //animate totalsats to start counting from zero
                    $({Counter: 0}).animate({
                        Counter: data.percentProfit
                    }, {
                        duration: 2000,
                        easing: 'swing',
                        step: function () {
                            $('#profit').text(Math.ceil(this.Counter) + "%");
                        }
                    });
                    // enable button again
                    $("#addressBtn").html('Show graph');
                });
        }

        $("#addressForm").on('submit', function (event) {
            // disable button , grey out and show spinner to indicate loading
            event.preventDefault(); // Prevent the form from submitting in the traditional way


            // Perform AJAX request
            let value = $('#addressInput').val().trim();
            getDataForAddress(value);
            history.replaceState( {} , '', '/' + value );
        });
    });
</script>
</body>
</html>